const l=[{url:"http://localhost:3000",apiUrl:"http://localhost:3001/api"},{url:"https://cvstomize-frontend-351889420459.us-central1.run.app",apiUrl:"https://cvstomize-api-351889420459.us-central1.run.app/api"},{url:"https://cvstomize.com",apiUrl:"https://cvstomize-api-351889420459.us-central1.run.app/api"}];async function u(){for(const r of l)try{const o=await chrome.tabs.query({url:`${r.url}/*`});if(o.length>0){const a=o[0],t=await chrome.scripting.executeScript({target:{tabId:a.id},func:()=>{const s=localStorage.getItem("cvstomize_dev_token");if(s)return s;const n=Object.keys(localStorage);for(const e of n)if(e.startsWith("firebase:authUser"))return JSON.parse(localStorage.getItem(e)).stsTokenManager.accessToken;return null}});if(t&&t[0]&&t[0].result)return{token:t[0].result,apiUrl:r.apiUrl}}}catch(o){console.log(`Failed to get token from ${r.url}`,o)}return null}chrome.runtime.onMessage.addListener(async(r,o,a)=>{if(r.action==="start_tailoring"){const t=await u();if(!t||!t.token){console.warn("No auth token found. User might not be logged in to CVstomize."),chrome.runtime.sendMessage({action:"ai_error",error:"Please log in to CVstomize in another tab first."});return}const{token:s,apiUrl:n}=t;try{chrome.runtime.sendMessage({action:"ai_progress",progress:.2,text:"Analyzing Job Description with Vertex AI..."});const e=await fetch(`${n}/ai/extension/tailor`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({jobDescription:r.jobText})});if(!e.ok){const c=await e.text();throw new Error(`API Error: ${e.status} ${c}`)}const i=await e.json();chrome.runtime.sendMessage({action:"ai_complete",result:i.result})}catch(e){console.error("AI API Error:",e),chrome.runtime.sendMessage({action:"ai_error",error:e.message}),chrome.runtime.sendMessage({action:"ai_progress",progress:0,text:`Error: ${e.message}`})}}});
