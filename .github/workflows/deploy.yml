name: Deploy CVstomize

on:
  push:
    branches:
      - dev      # Deploy to dev environment
      - staging  # Deploy to staging environment
      - main     # Deploy to production environment
  pull_request:
    branches:
      - main
      - staging

env:
  GCP_PROJECT_ID: cvstomize
  GCP_REGION: us-central1
  API_IMAGE: gcr.io/cvstomize/cvstomize-api
  FRONTEND_IMAGE: gcr.io/cvstomize/cvstomize-frontend

jobs:
  # ============================================
  # Determine Environment
  # ============================================
  setup:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      service_name: ${{ steps.set-env.outputs.service_name }}
      db_instance: ${{ steps.set-env.outputs.db_instance }}
      max_instances: ${{ steps.set-env.outputs.max_instances }}
    steps:
      - name: Set environment based on branch
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "service_name=cvstomize-api" >> $GITHUB_OUTPUT
            echo "db_instance=cvstomize-db" >> $GITHUB_OUTPUT
            echo "max_instances=10" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "service_name=cvstomize-api-staging" >> $GITHUB_OUTPUT
            echo "db_instance=cvstomize-db-staging" >> $GITHUB_OUTPUT
            echo "max_instances=5" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "service_name=cvstomize-api-dev" >> $GITHUB_OUTPUT
            echo "db_instance=cvstomize-db-dev" >> $GITHUB_OUTPUT
            echo "max_instances=2" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # Run Tests
  # ============================================
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: api
        run: npm install

      - name: Run tests
        working-directory: api
        run: npm test
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test:test@localhost:5432/test

      - name: Run linter
        working-directory: api
        run: npm run lint || echo "Linting issues found (non-blocking)"

  # ============================================
  # Build and Deploy Backend
  # ============================================
  deploy:
    needs: [setup, test]
    runs-on: ubuntu-latest
    # Only deploy on push (not PR)
    if: github.event_name == 'push'
    environment:
      name: ${{ needs.setup.outputs.environment }}
      url: https://${{ needs.setup.outputs.service_name }}-351889420459.us-central1.run.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Build Docker image
        run: |
          docker build -t ${{ env.API_IMAGE }}:${{ github.sha }} \
                       -t ${{ env.API_IMAGE }}:${{ needs.setup.outputs.environment }} \
                       -t ${{ env.API_IMAGE }}:latest \
                       ./api

      - name: Push Docker image
        run: |
          docker push ${{ env.API_IMAGE }}:${{ github.sha }}
          docker push ${{ env.API_IMAGE }}:${{ needs.setup.outputs.environment }}
          docker push ${{ env.API_IMAGE }}:latest

      - name: Deploy to Cloud Run
        run: |
          ENV=${{ needs.setup.outputs.environment }}
          SERVICE=${{ needs.setup.outputs.service_name }}
          DB_INSTANCE=${{ needs.setup.outputs.db_instance }}
          MAX_INSTANCES=${{ needs.setup.outputs.max_instances }}

          gcloud run deploy $SERVICE \
            --image=${{ env.API_IMAGE }}:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --service-account=cvstomize-deployer@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --add-cloudsql-instances=${{ env.GCP_PROJECT_ID }}:${{ env.GCP_REGION }}:$DB_INSTANCE \
            --set-env-vars="NODE_ENV=$ENV,LOG_LEVEL=info" \
            --set-secrets="DATABASE_URL=DATABASE_URL_$ENV:latest,JWT_SECRET=JWT_SECRET_$ENV:latest,GCS_BUCKET_NAME=GCS_BUCKET_NAME_$ENV:latest" \
            --port=3001 \
            --timeout=60 \
            --memory=2Gi \
            --cpu=2 \
            --max-instances=$MAX_INSTANCES \
            --min-instances=0 \
            --labels="app=cvstomize,env=$ENV,version=${{ github.sha }}"

      - name: Get service URL
        id: get-url
        run: |
          URL=$(gcloud run services describe ${{ needs.setup.outputs.service_name }} \
                --region=${{ env.GCP_REGION }} \
                --format="value(status.url)")
          echo "service_url=$URL" >> $GITHUB_OUTPUT
          echo "âœ… Deployed to: $URL"

      - name: Run smoke tests
        run: |
          URL=${{ steps.get-url.outputs.service_url }}
          echo "ðŸ§ª Testing $URL/health..."

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $URL/health)
          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸš€ Deployment Successful

          **Environment:** \`${{ needs.setup.outputs.environment }}\`
          **Service:** \`${{ needs.setup.outputs.service_name }}\`
          **Image:** \`${{ env.API_IMAGE }}:${{ github.sha }}\`
          **URL:** ${{ steps.get-url.outputs.service_url }}

          ### Git Info
          - **Branch:** \`${{ github.ref_name }}\`
          - **Commit:** \`${{ github.sha }}\`
          - **Author:** @${{ github.actor }}

          ### Next Steps
          - [ ] Test the deployment
          - [ ] Monitor logs
          - [ ] Update CHANGELOG

          EOF

  # ============================================
  # Notify on Failure
  # ============================================
  notify-failure:
    needs: [deploy]
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Notify deployment failure
        run: |
          echo "âŒ Deployment failed!"
          echo "Check the logs above for details."
          # TODO: Send Slack/Discord notification
